<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigrama RCM</title>
    
    <!-- FAVICONS -->
    <link rel="apple-touch-icon" sizes="57x57" href="assets/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="assets/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="assets/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="assets/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="assets/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="assets/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
    <link rel="manifest" href="assets/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="assets/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H3DNJQGN34"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-H3DNJQGN34');
    </script>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* --- CSS VARIABLES & THEMES --- */
        :root {
            /* Light Mode (Default) */
            --bg-color: #F4F4F4;
            --node-bg: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #757575;
            --accent-color: #FF3B30;
            --line-color: #C0C0C0;
            --card-bg: rgba(244, 244, 244, 0.75);
            --card-border: rgba(255, 255, 255, 0.5);
            --node-stroke: #E0E0E0;
            --node-stroke-collapsed: #999;
            --font-stack: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        /* Dark Mode Class */
        body.dark-mode {
            --bg-color: #121212;
            --node-bg: #1E1E1E;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --accent-color: #FF453A;
            --line-color: #404040;
            --card-bg: rgba(30, 30, 30, 0.75);
            --card-border: rgba(255, 255, 255, 0.1);
            --node-stroke: #333333;
            --node-stroke-collapsed: #666;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-stack);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- UI OVERLAYS --- */
        
        /* 1. Header Card */
        header {
            position: fixed;
            top: 24px;
            left: 24px;
            width: 380px;
            padding: 20px;
            z-index: 100;
            background-color: var(--card-bg); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px); 
            border: 1px solid var(--card-border);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 16px; 
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-text {
            display: flex;
            flex-direction: column;
        }

        h1 {
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 4px 0;
            color: var(--text-primary);
            letter-spacing: -0.01em;
            line-height: 1.2;
        }

        h2 {
            font-size: 13px;
            font-weight: 400;
            margin: 0;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* 2. Theme Toggle Switch */
        .theme-switch-wrapper {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 100;
            display: flex;
            align-items: center;
        }

        .theme-switch {
            display: inline-block;
            height: 34px;
            position: relative;
            width: 60px;
        }

        .theme-switch input {
            display: none;
        }

        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 26px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 26px;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .mode-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            pointer-events: none;
            user-select: none;
        }
        .icon-sun { left: 8px; color: #fff; opacity: 0; transition: opacity 0.3s; }
        .icon-moon { right: 8px; color: #555; opacity: 1; transition: opacity 0.3s; }
        
        input:checked ~ .slider .icon-sun { opacity: 1; }
        input:checked ~ .slider .icon-moon { opacity: 0; }


        /* 3. Footer (GitHub Info) */
        .footer-info {
            position: fixed;
            bottom: 16px;
            right: 24px;
            z-index: 90;
            font-size: 11px;
            color: var(--text-secondary);
            background-color: var(--card-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--card-border);
            text-align: right;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .footer-info a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 600;
        }

        .footer-info a:hover {
            text-decoration: underline;
        }

        /* --- CHART STYLES --- */
        svg {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        svg:active {
            cursor: grabbing;
        }

        .node rect {
            fill: var(--node-bg);
            stroke: var(--line-color);
            stroke-width: 1px;
            transition: fill 0.3s ease, stroke 0.3s ease;
        }

        .node:hover rect {
            stroke: var(--text-primary);
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.15));
        }

        .node-content-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 16px;
            box-sizing: border-box;
            pointer-events: none;
        }

        .node-role {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.25;
            margin-bottom: 2px;
            white-space: normal; 
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            transition: color 0.3s ease;
        }

        .node-person {
            font-size: 11px;
            font-weight: 400;
            color: var(--text-secondary);
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.3s ease;
        }

        .node-circle {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .node-circle:hover {
            transform: scale(1.2);
        }

        .link {
            fill: none;
            stroke: var(--line-color);
            stroke-width: 1.5px;
            transition: stroke 0.3s ease;
        }

        /* --- UTILS --- */
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: var(--text-secondary);
        }

        #error-msg {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--node-bg);
            color: var(--text-primary);
            padding: 30px;
            border-left: 4px solid var(--accent-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 400px;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="header-logo">
            <img src="assets/logos/RCM-UPR-logo.svg" alt="RCM Logo">
        </div>
        <div class="header-text">
            <h1>Recinto de Ciencias M√©dicas</h1>
            <h2>Estructura Organizacional Acad√©mica y Administrativa</h2>
        </div>
    </header>

    <!-- Dark Mode Toggle -->
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider round">
                <!-- Simple SVG icons for sun/moon inside slider -->
                <span class="mode-icon icon-moon">üåô</span>
                <span class="mode-icon icon-sun">‚òÄÔ∏è</span>
            </div>
        </label>
    </div>

    <!-- Footer Info -->
    <div class="footer-info">
        <span id="last-updated">Cargando fecha...</span><br>
        <a href="https://github.com/l-velazquez/Organigrama-RCM" target="_blank">Ver en GitHub</a>
    </div>

    <div id="loading">Cargando visualizaci√≥n...</div>
    
    <div id="error-msg">
        <h3>Error de conexi√≥n</h3>
        <p>No se pudo cargar 'organigrama.json'.</p>
        <p style="font-size: 12px; opacity: 0.7;">Aseg√∫rese de ejecutar este archivo usando un servidor local.</p>
    </div>

    <div id="chart"></div>

    <script>
        // --- 1. DARK MODE LOGIC ---
        const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
        const currentTheme = localStorage.getItem('theme');

        if (currentTheme) {
            document.body.classList[currentTheme === 'dark' ? 'add' : 'remove']('dark-mode');
            if (currentTheme === 'dark') {
                toggleSwitch.checked = true;
            }
        }

        function switchTheme(e) {
            if (e.target.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        }
        toggleSwitch.addEventListener('change', switchTheme, false);

        // --- 2. GITHUB LAST UPDATED LOGIC ---
        const repoOwner = 'l-velazquez';
        const repoName = 'Organigrama-RCM';
        const repoBranch = 'd3-gemini-3-pro';
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/commits?sha=${repoBranch}&per_page=1`;

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) throw new Error("GitHub API Error");
                return response.json();
            })
            .then(data => {
                if (data && data.length > 0) {
                    const dateStr = data[0].commit.committer.date;
                    const dateObj = new Date(dateStr);
                    
                    // Format date in Spanish
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    const formattedDate = dateObj.toLocaleDateString('es-ES', options);
                    
                    document.getElementById('last-updated').textContent = `Actualizado: ${formattedDate}`;
                }
            })
            .catch(err => {
                console.warn("Could not fetch GitHub date", err);
                document.getElementById('last-updated').textContent = "Fecha no disponible";
            });


        // --- 3. D3 CHART CONFIGURATION ---
        const width = window.innerWidth;
        const height = window.innerHeight;
        const duration = 600; 
        const nodeWidth = 240; 
        const nodeHeight = 85; 
        
        const svg = d3.select("#chart").append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(d3.zoom().scaleExtent([0.1, 2]).on("zoom", (event) => {
                g.attr("transform", event.transform);
            }))
            .append("g")
            .attr("transform", "translate(150, " + (height / 2) + ")");

        const g = svg.append("g");

        const treeMap = d3.tree().nodeSize([nodeHeight + 30, nodeWidth + 80]);

        let i = 0;
        let root;

        d3.json("organigrama.json")
            .then(data => {
                document.getElementById('loading').style.display = 'none';

                const rawRoot = data.organization.structure.rectoria;
                const processedData = formatData(rawRoot);

                root = d3.hierarchy(processedData, d => d.children);
                root.x0 = height / 2;
                root.y0 = 0;

                root.descendants().forEach(d => {
                    if (d.data.initial_collapsed && d.children) {
                        d._children = d.children;
                        d.children = null;
                    }
                });

                update(root);
            })
            .catch(error => {
                console.error(error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-msg').style.display = 'block';
            });

        function formatData(node) {
            let newNode = { ...node };
            if (newNode.sub_elements) {
                newNode.children = newNode.sub_elements.map(formatData);
                delete newNode.sub_elements;
            }
            return newNode;
        }

        function update(source) {
            const treeData = treeMap(root);
            const nodes = treeData.descendants();
            const links = treeData.links();

            nodes.forEach(d => { d.y = d.depth * 320; });

            // Nodes
            const node = g.selectAll('g.node')
                .data(nodes, d => d.id || (d.id = ++i));

            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr("transform", d => "translate(" + source.y0 + "," + source.x0 + ")")
                .on('click', click);

            // Rect
            nodeEnter.append('rect')
                .attr('width', nodeWidth)
                .attr('height', nodeHeight)
                .attr('x', 0)
                .attr('y', -nodeHeight / 2)
                .attr('rx', 6) 
                .attr('ry', 6);

            // Content
            nodeEnter.append('foreignObject')
                .attr('width', nodeWidth)
                .attr('height', nodeHeight)
                .attr('x', 0)
                .attr('y', -nodeHeight / 2)
                .append('xhtml:div')
                .attr('class', 'node-content-wrapper')
                .html(d => {
                    const role = d.data.name;
                    const person = d.data.head ? d.data.head : "";
                    let html = `<div class="node-role">${role}</div>`;
                    if (person) {
                        html += `<div class="node-person">${person}</div>`;
                    }
                    return html;
                });

            // Circle Toggle
            nodeEnter.append('circle')
                .attr('class', 'node-circle')
                .attr('r', 7)
                .attr('cx', nodeWidth)
                .attr('cy', 0)
                .style("opacity", d => (d._children || d.children) ? 1 : 0);

            const nodeUpdate = node.merge(nodeEnter);

            nodeUpdate.transition()
                .duration(duration)
                .attr("transform", d => "translate(" + d.y + "," + d.x + ")");

            // Note: Colors are handled by CSS variables now, but specific SVG attributes need update for transition
            // We use classes or simple selects, but D3 transitions on fill/stroke need explicit handling if variables change dynamically
            // However, CSS variables handle the theme switch, D3 handles the structure.
            // We just ensure the stroke changes based on collapse state.
            
            // Re-apply styles on update to catch collapse state changes
            nodeUpdate.select('rect')
                // Note: The main colors come from CSS (.node rect), 
                // but we need to set the stroke color for the collapsed state logic manually or via class.
                // Using inline style for the collapse logic, but utilizing CSS vars.
                .style("stroke", d => d._children ? "var(--node-stroke-collapsed)" : "var(--node-stroke)");

            nodeUpdate.select('circle.node-circle')
                .style("fill", d => d._children ? "var(--accent-color)" : "var(--node-bg)")
                .style("stroke", d => d._children ? "var(--accent-color)" : "var(--node-stroke-collapsed)")
                .style("opacity", d => (d._children || d.children) ? 1 : 0);


            const nodeExit = node.exit().transition()
                .duration(duration)
                .attr("transform", d => "translate(" + source.y + "," + source.x + ")")
                .remove();

            nodeExit.select('rect').attr('fill-opacity', 0);
            nodeExit.select('foreignObject').style('opacity', 0);
            nodeExit.select('circle').attr('opacity', 0);

            // Links
            const link = g.selectAll('path.link')
                .data(links, d => d.target.id);

            const linkEnter = link.enter().insert('path', "g")
                .attr("class", "link")
                .attr('d', d => {
                    const o = { x: source.x0, y: source.y0 };
                    return diagonal(o, o);
                });

            const linkUpdate = link.merge(linkEnter);

            linkUpdate.transition()
                .duration(duration)
                .attr('d', d => diagonal(d.source, d.target));

            link.exit().transition()
                .duration(duration)
                .attr('d', d => {
                    const o = { x: source.x, y: source.y };
                    return diagonal(o, o);
                })
                .remove();

            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });

            function diagonal(s, d) {
                const sourceX = s.y + nodeWidth;
                const sourceY = s.x;
                const targetX = d.y;
                const targetY = d.x;

                return `M ${sourceX} ${sourceY}
                        C ${(sourceX + targetX) / 2} ${sourceY},
                          ${(sourceX + targetX) / 2} ${targetY},
                          ${targetX} ${targetY}`;
            }

            function click(event, d) {
                if (d.children || d._children) {
                    if (d.children) {
                        d._children = d.children;
                        d.children = null;
                    } else {
                        d.children = d._children;
                        d._children = null;
                    }
                    update(d);
                }
            }
        }
    </script>
</body>
</html>